<!DOCTYPE html>
<html>
  <head>
    <title>My Discord OAuth2 App</title>
  </head>

  <body>
    <div id="info">Hoi!</div>
    <div id="avatar-container">
      <img
        id="avatar"
        alt="Avatar Discord"
        style="max-width: 100px; border-radius: 50%"
      />
    </div>

    <a href="/createGame">creer un tournois</a>
    <a href="/registerGame">Rejoindre un tournois</a>

    <a id="login" href="http://localhost:8000/auth/discord"
      >Identify Yourself</a
    >
    <button id="logout" style="display: none">Déconnexion</button>

    <script>
      window.onload = () => {
        fetch("http://localhost:8000/auth/userinfo", {
          credentials: "include",
        })
          .then((response) => {
            if (response.ok) {
              return response.json();
            }
            throw new Error("Utilisateur non connecté");
          })
          .then((userInfo) => {
            if (userInfo.username) {
              document.getElementById("info").innerText = `
                          Bonjour ${userInfo.username}!
                          Pseudo Discord: ${userInfo.username}
                        `;
              const avatarUrl = userInfo.avatar
                ? `https://cdn.discordapp.com/avatars/${userInfo.id}/${userInfo.avatar}.png`
                : "https://cdn.discordapp.com/embed/avatars/0.png";

              document.getElementById("avatar").src = avatarUrl;
              document.getElementById("login").style.display = "none";
              document.getElementById("logout").style.display = "block";
            }
          })
          .catch(() => {
            document.getElementById("login").style.display = "block";
          });

        // Gérer la déconnexion
        document.getElementById("logout").addEventListener("click", () => {
          fetch("http://localhost:8000/auth/logout", {
            method: "POST",
            credentials: "include",
          })
            .then(() => {
              document.getElementById("info").innerText = "Hoi!";
              document.getElementById("login").style.display = "block";
              document.getElementById("logout").style.display = "none";
            })
            .catch((error) =>
              console.error("Erreur lors de la déconnexion :", error)
            );
        });
      };
    </script>
  </body>
</html>
