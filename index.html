<!DOCTYPE html>
<html>
  <head>
    <title>My Discord OAuth2 App</title>
  </head>

  <body>
    <div id="info">Hoi!</div>
    <div id="tournamentInfo"></div>
    <!-- List of available tournaments -->
    <div id="avatar-container">
      <img
        id="avatar"
        alt="Avatar Discord"
        style="max-width: 100px; border-radius: 50%"
      />
    </div>

    <a
      href="/createTournament"
      id="create-tournament-link"
      style="display: none"
      >Créer un tournoi</a
    >
    <a id="login" href="http://localhost:8000/auth/discord"
      >Identify Yourself</a
    >
    <button id="logout" style="display: none">Déconnexion</button>

    <button id="viewTournament" onclick="window.location.href = '/tournament'">
      Voir les tournois
    </button>

    <script>
      window.onload = () => {
        // Récupérer les informations de l'utilisateur
        fetch("http://localhost:8000/auth/userinfo", {
          credentials: "include",
        })
          .then((response) => {
            if (response.ok) {
              return response.json();
            }
            throw new Error("Utilisateur non connecté");
          })
          .then((userInfo) => {
            document.getElementById("info").innerText = `
                          Bonjour ${userInfo.username}!
                          Pseudo Discord: ${userInfo.username}
                          Role: ${userInfo.role.role}
                        `;
            const avatarUrl = userInfo.avatar
              ? `https://cdn.discordapp.com/avatars/${userInfo.discordId}/${userInfo.avatar}.png`
              : "https://cdn.discordapp.com/embed/avatars/0.png";
            document.getElementById("avatar").src = avatarUrl;

            if (userInfo.role.role === "ADMIN") {
              document.getElementById(
                "create-tournament-link viewTournament"
              ).style.display = "block";
            }

            document.getElementById("login").style.display = "none";
            document.getElementById("logout").style.display = "block";
          })
          .catch(() => {
            document.getElementById("login").style.display = "block";
          });

        fetch("http://localhost:8000/tournament/", {
          credentials: "include",
        })
          .then((response) => {
            if (response.ok) {
              return response.json();
            }
            throw new Error("Erreur lors de la récupération des tournois");
          })
          .then((tournaments) => {
            const tournamentInfoDiv = document.getElementById("tournamentInfo");
            tournaments.forEach((tournament) => {
              const tournamentElement = document.createElement("div");
              tournamentElement.innerHTML = `
                <h3>${tournament.name}</h3>
                <p>${tournament.description}</p>
                <p>Type de jeu: ${tournament.tournamentType.name}</p>
                <img src="${tournament.game.image_url}" alt="Image du tournoi" style="width: 100px; height: 100px;"/>
                <p>${tournament.game.name}</p>
                <button id="registerButton-${tournament.id}" onclick="toggleRegistration('${tournament.id}')">S'inscrire</button>
                <a href="/tournament/${tournament.id}">Voir les détails du tournoi</a>
              `;
              tournamentInfoDiv.appendChild(tournamentElement);

              checkRegistrationStatus(tournament.id);
            });
          })
          .catch((error) => {
            console.error("Erreur lors de la récupération des jeux:", error);
          });

        // Gérer la déconnexion
        document.getElementById("logout").addEventListener("click", () => {
          fetch("http://localhost:8000/auth/logout", {
            method: "POST",
            credentials: "include",
          })
            .then(() => {
              document.getElementById("info").innerText = "Hoi!";
              document.getElementById("login").style.display = "block";
              document.getElementById("logout").style.display = "none";
            })
            .catch((error) =>
              console.error("Erreur lors de la déconnexion :", error)
            );
        });
      };

      // Vérification d'inscription au tournoi
      const checkRegistrationStatus = (tournamentId) => {
        fetch("http://localhost:8000/tournament/checkRegistration", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
          body: JSON.stringify({ tournamentId: tournamentId }),
        })
          .then((response) => {
            if (response.ok) {
              return response.json();
            }
            throw new Error("Erreur de vérification de l'inscription");
          })
          .then((data) => {
            const button = document.getElementById(
              `registerButton-${tournamentId}`
            );
            if (data.isRegistered) {
              button.innerText = "Se désinscrire";
              button.onclick = () => unregisterFortournament(tournamentId);
            } else {
              button.innerText = "S'inscrire";
              button.onclick = () => registerFortournament(tournamentId);
            }
          })
          .catch((error) => {
            console.error("Erreur:", error);
          });
      };

      // Inscrire un utilisateur au tournoi
      const registerFortournament = (tournamentId) => {
        fetch("http://localhost:8000/tournament/register", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
          body: JSON.stringify({ tournamentId: tournamentId }),
        })
          .then((response) => {
            if (response.ok) {
              alert("Inscription réussie !");
              checkRegistrationStatus(tournamentId);
            } else {
              throw new Error("Erreur lors de l'inscription");
            }
          })
          .catch((error) => {
            console.error(error);
            alert("Erreur lors de l'inscription");
          });
      };

      // Désinscrire un utilisateur du tournoi
      const unregisterFortournament = (tournamentId) => {
        fetch("http://localhost:8000/tournament/unregister", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
          body: JSON.stringify({ tournamentId: tournamentId }),
        })
          .then((response) => {
            if (response.ok) {
              alert("Désinscription réussie !");
              checkRegistrationStatus(tournamentId);
            } else {
              throw new Error("Erreur lors de la désinscription");
            }
          })
          .catch((error) => {
            console.error(error);
            alert("Erreur lors de la désinscription");
          });
      };
    </script>
  </body>
</html>
