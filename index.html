<!DOCTYPE html>
<html>
  <head>
    <title>My Discord OAuth2 App</title>
  </head>

  <body>
    <div id="info">Hoi!</div>
    <div id="gameInfo"></div>
    <!-- Affichage des informations sur les tournois -->
    <div id="avatar-container">
      <img
        id="avatar"
        alt="Avatar Discord"
        style="max-width: 100px; border-radius: 50%"
      />
    </div>

    <a href="/createGame" id="create-game-link" style="display: none"
      >Créer un tournoi</a
    >
    <a href="/registerGame">Rejoindre un tournoi</a>

    <a id="login" href="http://localhost:8000/auth/discord"
      >Identify Yourself</a
    >
    <button id="logout" style="display: none">Déconnexion</button>

    <script>
      window.onload = () => {
        // Récupérer les informations de l'utilisateur
        fetch("http://localhost:8000/auth/userinfo", {
          credentials: "include",
        })
          .then((response) => {
            if (response.ok) {
              return response.json(); // Convertit la réponse JSON
            }
            throw new Error("Utilisateur non connecté");
          })
          .then((userInfo) => {
            // Affiche les informations sur l'utilisateur
            document.getElementById("info").innerText = `
                          Bonjour ${userInfo.username}!
                          Pseudo Discord: ${userInfo.username}
                          Role: ${userInfo.role.role}
                        `;

            // Affiche l'avatar
            const avatarUrl = userInfo.avatar
              ? `https://cdn.discordapp.com/avatars/${userInfo.discordId}/${userInfo.avatar}.png`
              : "https://cdn.discordapp.com/embed/avatars/0.png";
            document.getElementById("avatar").src = avatarUrl;

            if (userInfo.role.role === "ADMIN") {
              document.getElementById("create-game-link").style.display =
                "block";
            }

            // Gère l'affichage des boutons
            document.getElementById("login").style.display = "none";
            document.getElementById("logout").style.display = "block";
          })
          .catch(() => {
            document.getElementById("login").style.display = "block";
          });

        // Récupérer les tournois disponibles
        fetch("http://localhost:8000/game/", {
          credentials: "include",
        })
          .then((response) => {
            if (response.ok) {
              return response.json(); // Récupérer les tournois
            }
            throw new Error("Erreur lors de la récupération des tournois");
          })
          .then((games) => {
            const gameInfoDiv = document.getElementById("gameInfo");
            games.forEach((game) => {
              const gameElement = document.createElement("div");
              gameElement.innerHTML = `
                <h3>${game.name}</h3>
                <p>${game.description}</p>
                <p>Type de jeu: ${game.gameType.name}</p>
              `;
              gameInfoDiv.appendChild(gameElement);
            });
          })
          .catch((error) => {
            console.error("Erreur lors de la récupération des jeux:", error);
          });

        // Gérer la déconnexion
        document.getElementById("logout").addEventListener("click", () => {
          fetch("http://localhost:8000/auth/logout", {
            method: "POST",
            credentials: "include",
          })
            .then(() => {
              document.getElementById("info").innerText = "Hoi!";
              document.getElementById("login").style.display = "block";
              document.getElementById("logout").style.display = "none";
            })
            .catch((error) =>
              console.error("Erreur lors de la déconnexion :", error)
            );
        });
      };
    </script>
  </body>
</html>
